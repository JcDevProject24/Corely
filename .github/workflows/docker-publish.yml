name: Build & Publish Docker Images

on:
  push:
    branches: [main]

jobs:
  analyze:
    name: Analyze Commit
    runs-on: ubuntu-latest
    outputs:
      action: ${{ steps.analyze.outputs.action }}
      new_version: ${{ steps.analyze.outputs.new_version }}
      backend_changed: ${{ steps.changes.outputs.backend }}
      frontend_changed: ${{ steps.changes.outputs.frontend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        id: changes
        run: |
          # Compare against previous commit
          BACKEND=$(git diff --name-only HEAD~1 HEAD -- backend/ | wc -l)
          FRONTEND=$(git diff --name-only HEAD~1 HEAD -- frontend/ | wc -l)

          if [ "$BACKEND" -gt 0 ]; then
            echo "backend=true" >> "$GITHUB_OUTPUT"
            echo "Backend has changes"
          else
            echo "backend=false" >> "$GITHUB_OUTPUT"
            echo "Backend has NO changes"
          fi

          if [ "$FRONTEND" -gt 0 ]; then
            echo "frontend=true" >> "$GITHUB_OUTPUT"
            echo "Frontend has changes"
          else
            echo "frontend=false" >> "$GITHUB_OUTPUT"
            echo "Frontend has NO changes"
          fi

      - name: Determine action and version
        id: analyze
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          # Get latest tag or default to 0.0.0
          LATEST_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n1 || echo "")
          if [ -z "$LATEST_TAG" ]; then
            CURRENT_VERSION="0.0.0"
          else
            CURRENT_VERSION="${LATEST_TAG#v}"
          fi
          echo "Current version: $CURRENT_VERSION"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # feat/fix → only build (verify), upload → build + push
          if echo "$COMMIT_MSG" | grep -qiE '^upload(\(.+\))?!:|^BREAKING CHANGE:'; then
            MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0
            ACTION="push"
          elif echo "$COMMIT_MSG" | grep -qiE '^upload(\(.+\))?:'; then
            MINOR=$((MINOR + 1)); PATCH=0
            ACTION="push"
          elif echo "$COMMIT_MSG" | grep -qiE '^feat(\(.+\))?:'; then
            MINOR=$((MINOR + 1)); PATCH=0
            ACTION="build"
          elif echo "$COMMIT_MSG" | grep -qiE '^fix(\(.+\))?:'; then
            PATCH=$((PATCH + 1))
            ACTION="build"
          else
            echo "No recognized prefix — skipping."
            echo "action=skip" >> "$GITHUB_OUTPUT"
            echo "new_version=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "Action: $ACTION | New version: $NEW_VERSION"
          echo "action=$ACTION" >> "$GITHUB_OUTPUT"
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

  # ── Backend ──
  backend:
    name: Backend
    runs-on: ubuntu-latest
    needs: analyze
    if: >-
      needs.analyze.outputs.action == 'push' ||
      (needs.analyze.outputs.action == 'build' && needs.analyze.outputs.backend_changed == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          load: true
          tags: corely:backend-test

      # Push only on "upload:" commits
      - name: Login to DockerHub (Jorge)
        if: needs.analyze.outputs.action == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push backend (Jorge)
        if: needs.analyze.outputs.action == 'push'
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/corely:backend-v${{ needs.analyze.outputs.new_version }}
            ${{ secrets.DOCKER_USERNAME }}/corely:backend-latest

      - name: Login to DockerHub (Sergio)
        if: needs.analyze.outputs.action == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME_SERGIO }}
          password: ${{ secrets.DOCKER_PASSWORD_SERGIO }}

      - name: Push backend (Sergio)
        if: needs.analyze.outputs.action == 'push'
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME_SERGIO }}/corely:backend-v${{ needs.analyze.outputs.new_version }}
            ${{ secrets.DOCKER_USERNAME_SERGIO }}/corely:backend-latest

  # ── Frontend ──
  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    needs: analyze
    if: >-
      needs.analyze.outputs.action == 'push' ||
      (needs.analyze.outputs.action == 'build' && needs.analyze.outputs.frontend_changed == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          load: true
          tags: corely:frontend-test

      - name: Login to DockerHub (Jorge)
        if: needs.analyze.outputs.action == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push frontend (Jorge)
        if: needs.analyze.outputs.action == 'push'
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/corely:frontend-v${{ needs.analyze.outputs.new_version }}
            ${{ secrets.DOCKER_USERNAME }}/corely:frontend-latest

      - name: Login to DockerHub (Sergio)
        if: needs.analyze.outputs.action == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME_SERGIO }}
          password: ${{ secrets.DOCKER_PASSWORD_SERGIO }}

      - name: Push frontend (Sergio)
        if: needs.analyze.outputs.action == 'push'
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME_SERGIO }}/corely:frontend-v${{ needs.analyze.outputs.new_version }}
            ${{ secrets.DOCKER_USERNAME_SERGIO }}/corely:frontend-latest

  # ── Git Tag (only on upload) ──
  tag:
    name: Create Git Tag
    runs-on: ubuntu-latest
    needs: [analyze, backend, frontend]
    if: >-
      always() &&
      needs.analyze.outputs.action == 'push' &&
      !contains(needs.*.result, 'failure')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "v${{ needs.analyze.outputs.new_version }}"
          git push origin "v${{ needs.analyze.outputs.new_version }}"
